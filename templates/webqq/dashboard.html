{% extends "index.html" %}

{% block right_content %}
    <div>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#contact-box" role="tab" data-toggle="tab">联系人</a>
            </li>
            <li role="presentation"><a href="#contact-group-box" aria-controls="profile" role="tab"
                                       data-toggle="tab">群组</a>
            </li>
            <li role="presentation"><a href="#messages" aria-controls="messages" role="tab"
                                       data-toggle="tab">配置</a></li>
        </ul>

        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="contact-box">
                <div class="row chat-box">
                    <div class="contact-list col-md-3">
                        <div class="contact-list-head">
                            <input type="text"/>
                        </div>

                        <div class="contact-list-content">
                            <div class="list-group">
                                {% for contact in request.user.userinfo.friends.select_related %}
                                    <a href="#" contact-id="{{ contact.id }}" contact-type="single"
                                       class="list-group-item">{{ contact.name }}</a>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                    <div class="col-md-9 dialog-box">
                        <div class="dialog-box-head">
                        </div>

                        <div class="dialog-box-content">
                            {% csrf_token %}
                        </div>
                        <div class="dialog-box-utils">
                            tools
                        </div>
                        <div class="dialog-box-sendmsg">
                            <textarea name="msg"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="contact-group-box">...</div>
            <div role="tabpanel" class="tab-pane" id="config">...</div>
        </div>

    </div>
{% endblock %}

{% block script %}
    <script type="text/javascript">

        $(function () {

            RefreshMsgs = setInterval(function(){
                GetNewMsg();
            }
            , 3000);


            $(".contact-list-content a").click(
                    function () {
                        $(this).addClass("active");
                        $(this).siblings().removeClass("active");
                        SwitchChatBox(this)
                    }
            );
        });


        $("body").delegate("textarea", "keydown", function (e) {
            if (e.which == 13) {
                var msg_text = $("textarea").val();
                if ($.trim(msg_text).length > 0) {
                    console.log(msg_text);
                    SendMsg(msg_text);
                }

                AddSendMsgIntoBox(msg_text);
                $("textarea").val("");
            }
        });

        function SwitchChatBox(ele) {
            var current_uid = $(ele).attr("contact-id");
            var current_dialog_type = $(ele).attr("contact-type");
            var current_contact_name = $(ele).text();
            var dialog_head_html = "<span contact-id='" + current_uid + "' contact-id='" + current_dialog_type + "'" +
                    " contact-type='" + current_dialog_type + "'>" + current_contact_name + "</span>";

            $(".dialog-box-head").html(dialog_head_html);
        }

        function AddSendMsgIntoBox(msg_text) {
            var msg_div = "<div class='pull right'>" +
                    "<span>" + "{{ request.user.userinfo }}" + "&nbsp;&nbsp;&nbsp;</span>" +
                    "<span>" + new Date().toLocaleTimeString() + "</span>" +
                    "<p>" + msg_text + "</p>"
            $(".dialog-box-content").append(msg_div);
            $(".dialog-box-content").animate({
                        scrollTop: $(".dialog-box-content")[0].scrollHeight
                    }, 500
            );
        }

        function GetNewMsg(){
            $.get("{% url 'get_new_msg' %}",
                    {"uid": "{{ request.user.userinfo.id }}"}, function(callback){
                        console.log(callback)
                    });
        }

        function SendMsg(msg) {
            var msg_dic = {
                "from_id": "{{ request.user.userinfo }}",
                "to_id": $(".dialog-box-head span").attr("contact-id"),
                "contact_type": $(".dialog-box-head span").attr("contact-type"),
                "msg": msg
            };

            $.post("{% url 'chat_send_msg' %}", {
                'data': JSON.stringify(msg_dic),
                "csrfmiddlewaretoken": $("input[name='csrfmiddlewaretoken']").val()
            }, function (callback) {
                console.log(callback);
            });
        }

    </script>
{% endblock %}